{% extends "base.html" %}

{% block title %}User Profile - Discord Review Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Users</a></li>
                <li class="breadcrumb-item active">Profile</li>
            </ol>
        </nav>
    </div>
</div>

<!-- User Header -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="discord-banner" id="userBanner" style="height: 200px; position: relative; background: linear-gradient(135deg, #7289da 0%, #99aab5 100%);">
                <div class="banner-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); height: 100px;"></div>
            </div>
            <div class="card-body" style="margin-top: -50px; position: relative; z-index: 1;">
                <div class="d-flex align-items-end mb-3">
                    <div class="me-4">
                        <img src="" alt="Avatar" class="rounded-circle discord-avatar border border-4 border-white shadow" 
                             data-user-id="{{ user_id }}" style="width: 120px; height: 120px;" 
                             onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                    </div>
                    <div class="flex-grow-1 text-white">
                        <h1 class="mb-1 discord-username" data-user-id="{{ user_id }}" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                            Loading...
                        </h1>
                        <p class="mb-0 discord-discriminator" data-user-id="{{ user_id }}" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                            User {{ user_id }}
                        </p>
                    </div>
                    <div class="text-end">
                        <div class="status-badge discord-status" data-user-id="{{ user_id }}">
                            <i class="fas fa-circle text-secondary"></i> Unknown
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="stat-icon mb-2">
                    <i class="fas fa-star fa-2x text-warning"></i>
                </div>
                <h3 class="card-title">{{ "%.1f"|format(stats.avg_rating) }}</h3>
                <p class="card-text text-muted">Average Rating</p>
                {% if stats.total_reviews > 0 %}
                    <small class="text-muted">{{ stats.avg_rating|star_display }}</small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="stat-icon mb-2">
                    <i class="fas fa-comments fa-2x text-primary"></i>
                </div>
                <h3 class="card-title">{{ stats.total_reviews }}</h3>
                <p class="card-text text-muted">Reviews Received</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="stat-icon mb-2">
                    <i class="fas fa-pen fa-2x text-success"></i>
                </div>
                <h3 class="card-title">{{ stats.reviews_given }}</h3>
                <p class="card-text text-muted">Reviews Given</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="stat-icon mb-2">
                    <i class="fas fa-list fa-2x text-info"></i>
                </div>
                <h3 class="card-title">{{ stats.thread_ids|length }}</h3>
                <p class="card-text text-muted">Active Posts</p>
            </div>
        </div>
    </div>
</div>

<!-- Discord Profile Info -->
<div class="row mb-4" id="discordInfo" style="display: block;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fab fa-discord me-2"></i>
                    Discord Profile
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6 mb-3">
                        <h6><i class="fas fa-award me-2"></i>Badges</h6>
                        <div id="badgesContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-award fa-2x mb-2"></i>
                                <p>No badges earned</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-3">
                        <h6><i class="fas fa-crown me-2"></i>Server Roles</h6>
                        <div id="rolesContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-user fa-2x mb-2"></i>
                                <p>No special roles</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Reviews Received -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-inbox"></i> Reviews Received
                    <span class="badge bg-primary ms-2">{{ stats.latest_reviews|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if stats.latest_reviews %}
                    <div class="reviews-list">
                        {% for review in stats.latest_reviews %}
                        <div class="review-item mb-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-start">
                                <img src="" alt="Reviewer Avatar" class="rounded-circle discord-avatar me-3" 
                                     data-user-id="{{ review.giver_id }}" style="width: 40px; height: 40px;" 
                                     onerror="this.src='https://cdn.discordapp.com/embed/avatars/1.png'">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <strong class="discord-username" data-user-id="{{ review.giver_id }}">
                                            User {{ review.giver_id }}
                                        </strong>
                                        <small class="text-muted">{{ review.created_at|format_date }}</small>
                                    </div>
                                    <div class="rating-display mb-2">
                                        {% set star_count = (review.rating / 2)|int %}
                                        {% for i in range(star_count) %}⭐{% endfor %}
                                        {% if review.rating % 2 %}✨{% endif %}
                                        {% for i in range(5 - star_count - (1 if review.rating % 2 else 0)) %}☆{% endfor %}
                                        <span class="ms-2 fw-bold">{{ review.rating }}/10</span>
                                    </div>
                                    {% if review.notes %}
                                        <p class="mb-0">{{ review.notes }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No reviews received yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Reviews Given -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-paper-plane"></i> Reviews Given
                    <span class="badge bg-success ms-2">{{ stats.reviews_given_data|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if stats.reviews_given_data %}
                    <div class="reviews-list">
                        {% for review in stats.reviews_given_data %}
                        <div class="review-item mb-3 p-3 bg-light rounded">
                            <div class="d-flex align-items-start">
                                <img src="" alt="Recipient Avatar" class="rounded-circle discord-avatar me-3" 
                                     data-user-id="{{ review.receiver_id }}" style="width: 40px; height: 40px;" 
                                     onerror="this.src='https://cdn.discordapp.com/embed/avatars/2.png'">
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <a href="{{ url_for('user_profile', user_id=review.receiver_id) }}" class="text-decoration-none">
                                            <strong class="discord-username" data-user-id="{{ review.receiver_id }}">
                                                User {{ review.receiver_id }}
                                            </strong>
                                        </a>
                                        <small class="text-muted">{{ review.created_at|format_date }}</small>
                                    </div>
                                    <div class="rating-display mb-2">
                                        {% set star_count = (review.rating / 2)|int %}
                                        {% for i in range(star_count) %}⭐{% endfor %}
                                        {% if review.rating % 2 %}✨{% endif %}
                                        {% for i in range(5 - star_count - (1 if review.rating % 2 else 0)) %}☆{% endfor %}
                                        <span class="ms-2 fw-bold">{{ review.rating }}/10</span>
                                    </div>
                                    {% if review.notes %}
                                        <p class="mb-2">{{ review.notes }}</p>
                                    {% endif %}
                                    <a href="#" class="btn btn-sm btn-outline-primary thread-link" data-thread-id="{{ review.thread_id }}">
                                        <i class="fab fa-discord"></i> View Thread
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-pen-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No reviews given yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Active Posts -->
{% if stats.thread_ids %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i> Active Posts
                    <span class="badge bg-info ms-2">{{ stats.thread_ids|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="threadsContainer">
                    {% for thread_id in stats.thread_ids %}
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="card thread-card" data-thread-id="{{ thread_id }}">
                            <div class="card-body">
                                <h6 class="card-title thread-name">Thread {{ thread_id }}</h6>
                                <p class="card-text">
                                    <small class="text-muted thread-date">Loading...</small>
                                </p>
                                <a href="#" class="btn btn-sm btn-primary thread-link" data-thread-id="{{ thread_id }}">
                                    <i class="fab fa-discord"></i> View on Discord
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadUserProfile();
    loadThreadInfo();
});

function loadUserProfile() {
    const userId = {{ user_id }};
    
    fetch(`/api/discord_user/${userId}`)
        .then(response => response.json())
        .then(data => {
            // Update avatar
            document.querySelectorAll('.discord-avatar[data-user-id="' + userId + '"]').forEach(img => {
                img.src = data.avatar_url;
                img.alt = data.username;
            });
            
            // Update username
            document.querySelectorAll('.discord-username[data-user-id="' + userId + '"]').forEach(element => {
                element.textContent = data.display_name || data.username;
            });
            
            // Update discriminator
            document.querySelectorAll('.discord-discriminator[data-user-id="' + userId + '"]').forEach(element => {
                element.textContent = `@${data.username}`;
            });
            
            // Update banner if available
            if (data.banner_url) {
                console.log('Setting banner:', data.banner_url);
                document.getElementById('userBanner').style.backgroundImage = `url(${data.banner_url})`;
                document.getElementById('userBanner').style.backgroundSize = 'cover';
                document.getElementById('userBanner').style.backgroundPosition = 'center';
            } else if (data.accent_color) {
                console.log('Setting accent color:', data.accent_color);
                // Use accent color as fallback
                const hexColor = '#' + data.accent_color.toString(16).padStart(6, '0');
                document.getElementById('userBanner').style.background = hexColor;
            } else {
                console.log('No banner or accent color found for user', data.id);
            }
            
            // Update status
            document.querySelectorAll('.discord-status[data-user-id="' + userId + '"]').forEach(element => {
                const statusIcon = element.querySelector('i');
                switch(data.status) {
                    case 'online':
                        statusIcon.className = 'fas fa-circle text-success';
                        element.innerHTML = '<i class="fas fa-circle text-success"></i> Online';
                        break;
                    case 'idle':
                        statusIcon.className = 'fas fa-moon text-warning';
                        element.innerHTML = '<i class="fas fa-moon text-warning"></i> Away';
                        break;
                    case 'dnd':
                        statusIcon.className = 'fas fa-minus-circle text-danger';
                        element.innerHTML = '<i class="fas fa-minus-circle text-danger"></i> Do Not Disturb';
                        break;
                    default:
                        statusIcon.className = 'fas fa-circle text-secondary';
                        element.innerHTML = '<i class="fas fa-circle text-secondary"></i> Offline';
                }
            });
            
            // Load enhanced profile data
            loadEnhancedProfileData(userId);
        })
        .catch(error => {
            console.error('Error loading user profile:', error);
        });
    
    // Load other users' data for reviews
    const otherUserAvatars = document.querySelectorAll('.discord-avatar:not([data-user-id="' + userId + '"])');
    const otherUsernames = document.querySelectorAll('.discord-username:not([data-user-id="' + userId + '"])');
    
    const otherUserIds = new Set();
    otherUserAvatars.forEach(avatar => {
        otherUserIds.add(avatar.getAttribute('data-user-id'));
    });
    
    otherUserIds.forEach(otherUserId => {
        fetch(`/api/discord_user/${otherUserId}`)
            .then(response => response.json())
            .then(data => {
                document.querySelectorAll('.discord-avatar[data-user-id="' + otherUserId + '"]').forEach(img => {
                    img.src = data.avatar_url;
                });
                document.querySelectorAll('.discord-username[data-user-id="' + otherUserId + '"]').forEach(element => {
                    element.textContent = data.display_name || data.username;
                });
            })
            .catch(error => console.error('Error loading other user data:', error));
    });
}

function loadThreadInfo() {
    const threadCards = document.querySelectorAll('.thread-card');
    
    threadCards.forEach(card => {
        const threadId = card.getAttribute('data-thread-id');
        
        fetch(`/api/thread_info/${threadId}`)
            .then(response => response.json())
            .then(data => {
                const nameElement = card.querySelector('.thread-name');
                const dateElement = card.querySelector('.thread-date');
                const linkElement = card.querySelector('.thread-link');
                
                nameElement.textContent = data.name || `Thread ${threadId}`;
                dateElement.textContent = `Created ${new Date(data.created_at).toLocaleDateString()}`;
                linkElement.href = data.url;
            })
            .catch(error => {
                console.error('Error loading thread info:', error);
            });
    });
    
    // Update all thread links
    document.querySelectorAll('.thread-link').forEach(link => {
        const threadId = link.getAttribute('data-thread-id');
        
        fetch(`/api/thread_info/${threadId}`)
            .then(response => response.json())
            .then(data => {
                link.href = data.url;
            })
            .catch(error => {
                link.href = '#';
                link.onclick = function(e) {
                    e.preventDefault();
                    alert('Unable to load Discord thread link');
                };
            });
    });
}

function loadEnhancedProfileData(userId) {
    fetch(`/api/discord_user/${userId}`)
        .then(response => response.json())
        .then(data => {
            console.log('Enhanced profile data loaded:', { badges: data.badges, roles: data.roles });
            
            // Display badges
            const badgesContainer = document.getElementById('badgesContainer');
            if (data.badges && data.badges.length > 0) {
                badgesContainer.innerHTML = '<div class="d-flex flex-wrap gap-2"></div>';
                const badgesList = badgesContainer.querySelector('.d-flex');
                
                data.badges.forEach(badge => {
                    const badgeElement = document.createElement('span');
                    badgeElement.className = 'badge d-flex align-items-center gap-1';
                    
                    // Remove any default styling that might cause conflicts
                    badgeElement.style.border = 'none';
                    badgeElement.style.boxShadow = 'none';
                    badgeElement.style.outline = 'none';
                    badgeElement.style.backgroundColor = badge.color || '#5865F2';
                    badgeElement.style.color = 'white';
                    
                    badgeElement.innerHTML = `
                        <span style="font-size: 0.8rem;">${badge.emoji}</span>
                        <span>${badge.name}</span>
                    `;
                    badgesList.appendChild(badgeElement);
                });
            } else {
                badgesContainer.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-award mb-2"></i>
                        <p class="mb-0 small">No badges earned</p>
                    </div>
                `;
            }
            
            // Display roles
            const rolesContainer = document.getElementById('rolesContainer');
            if (data.roles && data.roles.length > 0) {
                rolesContainer.innerHTML = '<div class="d-flex flex-wrap gap-2"></div>';
                const rolesList = rolesContainer.querySelector('.d-flex');
                
                data.roles.forEach(role => {
                    const roleElement = document.createElement('span');
                    roleElement.className = 'badge d-flex align-items-center gap-1';
                    
                    // Remove any default styling that might cause conflicts
                    roleElement.style.border = 'none';
                    roleElement.style.boxShadow = 'none';
                    roleElement.style.outline = 'none';
                    
                    if (role.color && role.color !== '#000000' && role.color !== '#000') {
                        roleElement.style.backgroundColor = role.color;
                        roleElement.style.color = 'white';
                    } else {
                        // Use our theme variable instead of Bootstrap class
                        roleElement.style.backgroundColor = 'var(--text-secondary)';
                        roleElement.style.color = 'white';
                    }
                    
                    roleElement.innerHTML = `
                        <span>${role.hoisted ? '📌' : '👤'}</span>
                        <span>${role.name}</span>
                    `;
                    rolesList.appendChild(roleElement);
                });
            } else {
                rolesContainer.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-user mb-2"></i>
                        <p class="mb-0 small">No special roles</p>
                    </div>
                `;
            }
            
            // Always show the Discord info section since we have profile data
            document.getElementById('discordInfo').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading enhanced profile data:', error);
        });
}
</script>
{% endblock %}